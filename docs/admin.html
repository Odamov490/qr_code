<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Admin</title>

  <!-- Sizning CSS -->
  <link rel="stylesheet" href="assets/style.css" />

  <!-- QR kutubxona -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
    integrity="sha512-CNgIRecPoPFcAckU4iigFsMghvYDn8ApX2HFqRSbuuSSMzdg3NofM8JrIoVNewc0hXtF87Qy4V/mQJu1WDVYjA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Admin layout uchun qo‚Äòshimcha (faqat shu sahifaga) -->
  <style>
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh;background:var(--bg)}
    .sidebar{background:var(--card);border-right:1px solid var(--border);padding:16px;position:sticky;top:0;height:100vh}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:38px;height:38px;border-radius:12px;background:var(--primary-soft);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--primary)}
    .brand h1{font-size:16px;margin:0}
    .nav{margin-top:14px;display:flex;flex-direction:column;gap:8px}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text)}
    .nav a:hover{background:var(--secondary);text-decoration:none}
    .nav a.active{background:var(--primary-soft);border-color:transparent;color:var(--primary);font-weight:700}
    .hint{margin-top:14px;font-size:12px;color:var(--muted);line-height:1.4}
    .main{padding:18px}
    .topbar{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .search{flex:1;display:flex;gap:10px;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;color:var(--muted);font-size:13px}
    .content{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media(max-width:980px){.app{grid-template-columns:1fr}.sidebar{position:relative;height:auto}.content{grid-template-columns:1fr}}
    .section-title{display:flex;align-items:center;gap:10px;margin:0 0 10px 0}
    .section-title span{font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.two{grid-template-columns:1fr}}
    .kpi{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:900px){.kpi{grid-template-columns:1fr}}
    .kpi .card{padding:14px}
    .kpi b{font-size:18px}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 12px;border-radius:12px;display:none;max-width:340px}
    .mono-wrap{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px}
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">QR</div>
        <div>
          <h1>QR Admin Panel</h1>
          <div class="muted small">Serversiz ‚Ä¢ GitHub Pages</div>
        </div>
      </div>

      <nav class="nav">
        <a class="active" href="#create">‚ûï QR yaratish</a>
        <a href="index.html">üìã Ro‚Äòyxat</a>
        <a href="manifest.json" target="_blank">üóÇ manifest.json</a>
      </nav>

      <div class="hint">
        ‚úÖ QR o‚Äòzgarmaydi: ID doim bir xil bo‚Äòlsin.<br/>
        ‚úÖ PDF yangilash: <span class="mono">pdfs/ID.pdf</span> faylni almashtiring.<br/>
        ‚ö†Ô∏è PDF ‚Äúupload‚Äù bu yerda emas ‚Äî GitHub commit orqali.
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- TOPBAR -->
      <div class="topbar">
        <div class="pill">üß™ Lab hujjatlar bazasi</div>
        <div class="search">
          <input id="quickId" placeholder="Tez ID kiritish (masalan: ESW8-000124)..." />
        </div>
        <a class="btn secondary" href="index.html">Ro‚Äòyxat</a>
      </div>

      <!-- KPI -->
      <div class="kpi">
        <div class="card">
          <div class="muted small">QR link</div>
          <b class="mono" id="kpiLink">‚Äî</b>
        </div>
        <div class="card">
          <div class="muted small">PDF yo‚Äòli</div>
          <b class="mono" id="kpiPdf">‚Äî</b>
        </div>
        <div class="card">
          <div class="muted small">ID</div>
          <b class="mono" id="kpiId">‚Äî</b>
        </div>
      </div>

      <div class="content" style="margin-top:16px">
        <!-- LEFT: FORM -->
        <section class="card" id="create">
          <h2 class="section-title">‚ûï QR yaratish <span>(ID ‚Üí QR ‚Üí manifest yozuvi)</span></h2>

          <div class="two">
            <div>
              <div class="muted small">ID (QR doim shu ID bilan qoladi)</div>
              <input id="id" placeholder="Masalan: ESW8-000124" />
            </div>
            <div>
              <div class="muted small">PDF yo‚Äòli (repo ichida)</div>
              <input id="pdf" placeholder="pdfs/ESW8-000124.pdf" />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="two">
            <div>
              <div class="muted small">Hujjat nomi</div>
              <input id="title" placeholder="Masalan: ESW8 yo‚Äòriqnoma" />
            </div>
            <div>
              <div class="muted small">Uskuna</div>
              <input id="eq" placeholder="Masalan: Rohde & Schwarz ESW8" />
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="gen">QR yaratish</button>
            <button class="btn secondary" id="sample">Namuna</button>
            <button class="btn secondary" id="copyLink">QR linkni nusxa</button>
          </div>

          <div style="margin-top:14px">
            <div class="muted small">manifest.json uchun (copy/paste)</div>
            <textarea id="json" rows="9" style="margin-top:8px"></textarea>
          </div>
        </section>

        <!-- RIGHT: QR + DOWNLOAD -->
        <section class="card">
          <h2 class="section-title">üìé QR <span>(PNG yuklab olish)</span></h2>

          <div class="mono-wrap">
            <div class="muted small">QR link</div>
            <div class="mono" id="link" style="word-break:break-all">‚Äî</div>
          </div>

          <div style="margin-top:12px">
            <div id="qr" class="qrbox"></div>
          </div>

          <div class="actions" style="margin-top:12px">
            <button class="btn secondary" id="download">‚¨áÔ∏è QR PNG</button>
            <button class="btn secondary" id="openPdf">üìÑ PDF ochish</button>
          </div>

          <div style="margin-top:12px" class="muted small">
            Eslatma: QR link doim o‚Äòzgarmaydi. PDF‚Äôni keyin yangilash uchun GitHub‚Äôda
            <span class="mono">docs/pdfs/ID.pdf</span> faylni almashtiring.
          </div>
        </section>
      </div>
    </main>
  </div>

  <div class="toast" id="toast"></div>

<script>
const elId = document.getElementById('id');
const elTitle = document.getElementById('title');
const elEq = document.getElementById('eq');
const elPdf = document.getElementById('pdf');
const elLink = document.getElementById('link');
const elJson = document.getElementById('json');
const qrWrap = document.getElementById('qr');
const quickId = document.getElementById('quickId');

const kpiLink = document.getElementById('kpiLink');
const kpiPdf = document.getElementById('kpiPdf');
const kpiId = document.getElementById('kpiId');

let qr = null;

function toast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display='none', 1800);
}

function baseUrl(){
  const u = new URL(location.href);
  u.pathname = u.pathname.replace(/\/admin\.html$/,'/');
  return u.origin + u.pathname;
}
function makeLink(id){
  return baseUrl() + 'p.html?id=' + encodeURIComponent(id);
}

function updateKpi(id, pdf, link){
  kpiId.textContent = id || '‚Äî';
  kpiPdf.textContent = pdf || '‚Äî';
  kpiLink.textContent = link || '‚Äî';
}

document.getElementById('sample').onclick = () => {
  const id = 'DOC-' + String(Math.floor(Math.random()*900000)+100000);
  elId.value = id;
  elTitle.value = 'Uskuna yo‚Äòriqnomasi';
  elEq.value = 'Laboratoriya uskunasi';
  elPdf.value = 'pdfs/' + id + '.pdf';
  quickId.value = id;
  toast("Namuna to‚Äòldirildi");
};

document.getElementById('gen').onclick = () => {
  const id = (elId.value || quickId.value || '').trim();
  if(!id){ alert('ID kiriting'); return; }

  // PDF default
  const pdf = (elPdf.value || ('pdfs/' + id + '.pdf')).trim();
  elId.value = id;
  elPdf.value = pdf;

  const link = makeLink(id);
  elLink.textContent = link;

  // QR
  qrWrap.innerHTML = '';
  qr = new QRCode(qrWrap, { text: link, width: 240, height: 240 });

  // manifest JSON bo‚Äòlagi
  const item = {
    title: (elTitle.value || '').trim(),
    equipment: (elEq.value || '').trim(),
    pdf: pdf,
    tags: []
  };
  elJson.value = JSON.stringify({ [id]: item }, null, 2);

  updateKpi(id, pdf, link);
  toast("QR yaratildi");
};

document.getElementById('download').onclick = () => {
  if(!qr){ alert('Avval QR yarating'); return; }
  const img = qrWrap.querySelector('img');
  const canvas = qrWrap.querySelector('canvas');
  let dataUrl = null;
  if(img) dataUrl = img.src;
  if(canvas) dataUrl = canvas.toDataURL('image/png');
  if(!dataUrl){ alert('QR topilmadi'); return; }
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = (elId.value.trim() || 'qr') + '.png';
  a.click();
  toast("QR PNG yuklandi");
};

document.getElementById('copyLink').onclick = async () => {
  const text = elLink.textContent || '';
  if(!text || text === '‚Äî'){ alert('Avval QR yarating'); return; }
  try{
    await navigator.clipboard.writeText(text);
    toast("Link nusxalandi");
  }catch(e){
    toast("Clipboard ruxsat bermadi");
  }
};

document.getElementById('openPdf').onclick = () => {
  const pdf = (elPdf.value || '').trim();
  if(!pdf){ alert('PDF yo‚Äòlini kiriting'); return; }
  window.open(pdf, '_blank');
};

quickId.addEventListener('input', () => {
  const id = (quickId.value||'').trim();
  if(id && !elPdf.value.trim()) elPdf.value = 'pdfs/' + id + '.pdf';
});
</script>
</body>
</html>
